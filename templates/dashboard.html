<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #f8f9fa;
        }

        .dashboard-container {
            max-width: 900px;
            margin: 50px auto;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0px 0px 10px rgba(0, 0, 0, 0.1);
        }
    </style>
</head>

<body>
    <div class="dashboard-container">
        <h2 class="text-center">Dashboard</h2>

        <!-- Flash messages -->
        {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
        {% for category, message in messages %}
        <div class="alert alert-{{ 'danger' if category == 'error' else 'warning' if category == 'warning' else 'success' }} alert-dismissible fade show"
            role="alert">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
        {% endfor %}
        {% endif %}
        {% endwith %}

        <!-- Zeppelin Status -->
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">–°—Ç–∞—Ç—É—Å —Å–µ—Ä–≤–∏—Å–∞ Zeppelin</h5>
                <div>
                    <button type="button" class="btn btn-sm btn-outline-primary" onclick="refreshStatus()">
                        <span id="refresh-icon">üîÑ</span> –û–±–Ω–æ–≤–∏—Ç—å
                    </button>
                    <form action="{{ url_for('start_zeppelin') }}" method="POST" class="d-inline"></form>
                    <button type="submit" class="btn btn-sm btn-success"
                        onclick="return confirm('–ó–∞–ø—É—Å—Ç–∏—Ç—å —Å–µ—Ä–≤–∏—Å Zeppelin?')">
                        ‚ñ∂Ô∏è –ó–∞–ø—É—Å—Ç–∏—Ç—å
                    </button>
                    </form>
                    <form action="{{ url_for('stop_zeppelin') }}" method="POST" class="d-inline">
                        <button type="submit" class="btn btn-sm btn-danger"
                            onclick="return confirm('–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å–µ—Ä–≤–∏—Å Zeppelin?')">
                            ‚èπÔ∏è –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å
                        </button>
                    </form>
                    <form action="{{ url_for('restart') }}" method="POST" class="d-inline">
                        <button type="submit" class="btn btn-sm btn-warning"
                            onclick="return confirm('–ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å —Å–µ—Ä–≤–∏—Å Zeppelin?')">
                            ‚ö° –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å
                        </button>
                    </form>
                </div>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <div id="status-info">
                            {% if zeppelin_status %}
                            <div class="d-flex align-items-center mb-2">
                                <span class="badge bg-{{ zeppelin_status.status_class }} me-2">{{
                                    zeppelin_status.status_text }}</span>
                                <small class="text-muted">–°—Ç–∞—Ç—É—Å: {{ zeppelin_status.active }}</small>
                            </div>
                            {% if zeppelin_status.pid != 'N/A' %}
                            <p class="mb-1"><strong>PID:</strong> {{ zeppelin_status.pid }}</p>
                            {% endif %}
                            {% if zeppelin_status.memory_usage != 'N/A' %}
                            <p class="mb-1"><strong>–ü–∞–º—è—Ç—å:</strong> {{ zeppelin_status.memory_usage }}</p>
                            {% endif %}
                            {% if zeppelin_status.uptime != 'N/A' %}
                            <p class="mb-1"><strong>–í—Ä–µ–º—è —Ä–∞–±–æ—Ç—ã:</strong> {{ zeppelin_status.uptime }}</p>
                            {% endif %}
                            {% if zeppelin_status.enabled %}
                            <p class="mb-1"><strong>–ê–≤—Ç–æ–∑–∞–ø—É—Å–∫:</strong> {{ zeppelin_status.enabled }}</p>
                            {% endif %}
                            {% if zeppelin_status.service_manager %}
                            <p class="mb-1"><strong>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:</strong> {{ zeppelin_status.service_manager }}</p>
                            {% endif %}
                            {% if zeppelin_status.error %}
                            <div class="alert alert-danger mt-2">{{ zeppelin_status.error }}</div>
                            {% endif %}
                            {% else %}
                            <div class="alert alert-warning">–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Å—Ç–∞—Ç—É—Å —Å–µ—Ä–≤–∏—Å–∞</div>
                            {% endif %}
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="text-end">
                            <small class="text-muted">–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ: <span id="last-update">--:--:--</span></small>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="d-flex justify-content-between mb-3">
            <h5>Users & Roles</h5>
            <div>
                <a href="{{ url_for('logout') }}" class="btn btn-danger">Logout</a>
            </div>
        </div>
        
        <div class="alert alert-info">
            <strong>‚ÑπÔ∏è –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è:</strong> –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ —Å —Å—Ç–∞—Ç—É—Å–æ–º "–ó–∞—â–∏—â–µ–Ω" –Ω–µ –º–æ–≥—É—Ç –±—ã—Ç—å —É–¥–∞–ª–µ–Ω—ã –∏–ª–∏ –∏–∑–º–µ–Ω–µ–Ω—ã —á–µ—Ä–µ–∑ —ç—Ç–æ—Ç –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å.
        </div>

        <table class="table table-striped">
            <thead>
                <tr>
                    <th>Username</th>
                    <th>Roles</th>
                    <th>Status</th>
                </tr>
            </thead>
            <tbody>
                {% for user, user_data in users.items() %}
                <tr>
                    <td>{{ user }}</td>
                    <td>
                        {% if user_data.protected %}
                            <span class="text-muted">*** (–∑–∞—â–∏—â–µ–Ω–æ)</span>
                        {% else %}
                            {{ ', '.join(user_data.roles) }}
                        {% endif %}
                    </td>
                    <td>
                        {% if user_data.protected %}
                            <span class="badge bg-warning">–ó–∞—â–∏—â–µ–Ω</span>
                        {% else %}
                            <span class="badge bg-success">–û–±—ã—á–Ω—ã–π</span>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>

        <h5 class="mt-4">Manage Users</h5>
        <form action="{{ url_for('add_user') }}" method="POST" class="d-flex mb-3">
            <input type="text" class="form-control me-2" name="username" placeholder="New Username" required>
            <input type="password" class="form-control me-2" name="password" placeholder="Password" required>
            <button type="submit" class="btn btn-success">Add User</button>
        </form>

        <h5>Assign Role</h5>
        <form action="{{ url_for('assign_user_role') }}" method="POST" class="d-flex mb-3">
            <select class="form-select me-2" name="username">
                {% for user, user_data in users.items() %}
                    {% if not user_data.protected %}
                        <option value="{{ user }}">{{ user }}</option>
                    {% endif %}
                {% endfor %}
            </select>
            <select class="form-select me-2" name="role">
                {% for role in roles.keys() %}
                <option value="{{ role }}">{{ role }}</option>
                {% endfor %}
            </select>
            <button type="submit" class="btn btn-primary">Assign Role</button>
        </form>

        <h5>Unassign Role</h5>
        <form action="{{ url_for('unassign_user_role') }}" method="POST" class="d-flex mb-3">
            <select class="form-select me-2" name="username">
                {% for user, user_data in users.items() %}
                    {% if not user_data.protected %}
                        <option value="{{ user }}">{{ user }}</option>
                    {% endif %}
                {% endfor %}
            </select>
            <select class="form-select me-2" name="role">
                {% for role in roles.keys() %}
                <option value="{{ role }}">{{ role }}</option>
                {% endfor %}
            </select>
            <button type="submit" class="btn btn-warning">Remove Role</button>
        </form>

        <h5>Remove User</h5>
        <form action="{{ url_for('delete_user') }}" method="POST" class="d-flex mb-3">
            <select class="form-select me-2" name="username">
                {% for user, user_data in users.items() %}
                    {% if not user_data.protected %}
                        <option value="{{ user }}">{{ user }}</option>
                    {% endif %}
                {% endfor %}
            </select>
            <button type="submit" class="btn btn-danger"
                onclick="return confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è?')">Delete</button>
        </form>

        <h5>Add New Role</h5>
        <form action="{{ url_for('add_role') }}" method="POST" class="d-flex">
            <input type="text" class="form-control me-2" name="role_name" placeholder="New Role Name" required>
            <button type="submit" class="btn btn-secondary">Add Role</button>
        </form>
    </div>
    <footer>
        &copy; iwizard7 | <a href="https://github.com/iwizard7/zeppelin_user_mgmnt" target="_blank">GitHub
            Repository</a>
    </footer>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let statusUpdateInterval;

        function refreshStatus() {
            const refreshIcon = document.getElementById('refresh-icon');
            const statusInfo = document.getElementById('status-info');
            const lastUpdate = document.getElementById('last-update');

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
            refreshIcon.style.animation = 'spin 1s linear infinite';

            fetch('/check_zeppelin_status')
                .then(response => response.json())
                .then(data => {
                    updateStatusDisplay(data);
                    lastUpdate.textContent = new Date().toLocaleTimeString();
                })
                .catch(error => {
                    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Å—Ç–∞—Ç—É—Å–∞:', error);
                    statusInfo.innerHTML = '<div class="alert alert-danger">–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Å—Ç–∞—Ç—É—Å–∞ —Å–µ—Ä–≤–∏—Å–∞</div>';
                })
                .finally(() => {
                    // –£–±–∏—Ä–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
                    refreshIcon.style.animation = '';
                });
        }

        function updateStatusDisplay(status) {
            const statusInfo = document.getElementById('status-info');

            let html = `
                <div class="d-flex align-items-center mb-2">
                    <span class="badge bg-${status.status_class} me-2">${status.status_text}</span>
                    <small class="text-muted">–°—Ç–∞—Ç—É—Å: ${status.active || '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'}</small>
                </div>
            `;

            if (status.pid && status.pid !== 'N/A') {
                html += `<p class="mb-1"><strong>PID:</strong> ${status.pid}</p>`;
            }

            if (status.memory_usage && status.memory_usage !== 'N/A') {
                html += `<p class="mb-1"><strong>–ü–∞–º—è—Ç—å:</strong> ${status.memory_usage}</p>`;
            }

            if (status.uptime && status.uptime !== 'N/A') {
                html += `<p class="mb-1"><strong>–í—Ä–µ–º—è —Ä–∞–±–æ—Ç—ã:</strong> ${status.uptime}</p>`;
            }

            if (status.enabled) {
                html += `<p class="mb-1"><strong>–ê–≤—Ç–æ–∑–∞–ø—É—Å–∫:</strong> ${status.enabled}</p>`;
            }
            
            if (status.service_manager) {
                html += `<p class="mb-1"><strong>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:</strong> ${status.service_manager}</p>`;
            }

            if (status.error) {
                html += `<div class="alert alert-danger mt-2">${status.error}</div>`;
            }

            statusInfo.innerHTML = html;
        }

        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥
        function startAutoRefresh() {
            statusUpdateInterval = setInterval(refreshStatus, 30000);
        }

        function stopAutoRefresh() {
            if (statusUpdateInterval) {
                clearInterval(statusUpdateInterval);
            }
        }

        // –ó–∞–ø—É—Å–∫–∞–µ–º –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        document.addEventListener('DOMContentLoaded', function () {
            startAutoRefresh();
        });

        // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–∏ —É—Ö–æ–¥–µ —Å–æ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        window.addEventListener('beforeunload', function () {
            stopAutoRefresh();
        });

        // CSS –¥–ª—è –∞–Ω–∏–º–∞—Ü–∏–∏ –≤—Ä–∞—â–µ–Ω–∏—è
        const style = document.createElement('style');
        style.textContent = `
            @keyframes spin {
                0% { transform: rotate(0deg); }
                100% { transform: rotate(360deg); }
            }
        `;
        document.head.appendChild(style);
    </script>
</body>

</html>