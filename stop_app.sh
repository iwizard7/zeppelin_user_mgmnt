#!/bin/bash

# üõë –°–∫—Ä–∏–ø—Ç –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ Zeppelin User Management –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è

echo "üõë –û—Å—Ç–∞–Ω–æ–≤–∫–∞ Zeppelin User Management..."

# –ò—â–µ–º –ø—Ä–æ—Ü–µ—Å—Å—ã –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
APP_PIDS=$(ps aux | grep "app.py" | grep -v grep | awk '{print $2}')

if [ -z "$APP_PIDS" ]; then
    echo "‚ÑπÔ∏è  –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –Ω–µ –∑–∞–ø—É—â–µ–Ω–æ"
    
    # –û—á–∏—â–∞–µ–º —Ñ–∞–π–ª PID –µ—Å–ª–∏ –æ–Ω —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
    if [ -f ".app_pid" ]; then
        rm .app_pid
        echo "üßπ –û—á–∏—â–µ–Ω —Ñ–∞–π–ª PID"
    fi
    
    exit 0
fi

echo "üìä –ù–∞–π–¥–µ–Ω–Ω—ã–µ –ø—Ä–æ—Ü–µ—Å—Å—ã:"
ps aux | grep "app.py" | grep -v grep

echo ""
echo "üîÑ –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–æ—Ü–µ—Å—Å—ã..."

# –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–∞–∂–¥—ã–π –ø—Ä–æ—Ü–µ—Å—Å
for PID in $APP_PIDS; do
    echo "üõë –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–æ—Ü–µ—Å—Å $PID..."
    
    # –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–±—É–µ–º –º—è–≥–∫—É—é –æ—Å—Ç–∞–Ω–æ–≤–∫—É (SIGTERM)
    kill -TERM $PID 2>/dev/null
    
    # –ñ–¥–µ–º 5 —Å–µ–∫—É–Ω–¥
    sleep 5
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –æ—Å—Ç–∞–Ω–æ–≤–∏–ª—Å—è –ª–∏ –ø—Ä–æ—Ü–µ—Å—Å
    if ps -p $PID > /dev/null 2>&1; then
        echo "‚ö†Ô∏è  –ü—Ä–æ—Ü–µ—Å—Å $PID –Ω–µ –æ—Å—Ç–∞–Ω–æ–≤–∏–ª—Å—è, –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–∞—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∞..."
        kill -KILL $PID 2>/dev/null
        sleep 2
        
        if ps -p $PID > /dev/null 2>&1; then
            echo "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø—Ä–æ—Ü–µ—Å—Å $PID"
        else
            echo "‚úÖ –ü—Ä–æ—Ü–µ—Å—Å $PID –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
        fi
    else
        echo "‚úÖ –ü—Ä–æ—Ü–µ—Å—Å $PID –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
    fi
done

# –û—á–∏—â–∞–µ–º —Ñ–∞–π–ª PID
if [ -f ".app_pid" ]; then
    rm .app_pid
    echo "üßπ –û—á–∏—â–µ–Ω —Ñ–∞–π–ª PID"
fi

# –§–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞
REMAINING_PIDS=$(ps aux | grep "app.py" | grep -v grep | awk '{print $2}')
if [ -z "$REMAINING_PIDS" ]; then
    echo "‚úÖ –í—Å–µ –ø—Ä–æ—Ü–µ—Å—Å—ã –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã"
else
    echo "‚ö†Ô∏è  –û—Å—Ç–∞–ª–∏—Å—å –∑–∞–ø—É—â–µ–Ω–Ω—ã–µ –ø—Ä–æ—Ü–µ—Å—Å—ã:"
    ps aux | grep "app.py" | grep -v grep
fi

echo "üèÅ –ì–æ—Ç–æ–≤–æ!"